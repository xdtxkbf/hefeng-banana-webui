# Banana批量并发处理工具

## 功能说明

这个工具可以批量并发地提交banana图像生成任务，支持：
- 批量处理input/image目录中的所有图像
- 使用input/text/text.txt中的提示词
- 并发执行多个任务，提高处理效率
- 自动保存生成的图像到batch_outputs目录

## 项目结构

```
banana/
├── api_client.py              # API客户端
├── config.py                  # 配置模块
├── utils.py                   # 工具函数
├── upload.py                  # 文件上传模块（占位符）
├── batch_banana_concurrent.py # 批量并发处理脚本
├── .env                       # 环境变量配置
├── input/                     # 输入目录
│   ├── image/                 # 输入图像目录
│   │   ├── image1.jpg
│   │   ├── image2.png
│   │   └── ...
│   └── text/                  # 文本提示词目录
│       └── text.txt           # 提示词文件
└── batch_outputs/             # 输出目录（自动创建）
```

## 使用方法

### 1. 准备工作

确保已安装依赖：
```powershell
pip install requests pillow python-dotenv
```

### 2. 配置API密钥

在 `.env` 文件中设置API密钥：
```
GRSAI_API_KEY=your_api_key_here
```

### 3. 准备输入文件

- **图像文件**: 将需要处理的图像放入 `input/image/` 目录
  - 支持格式: jpg, jpeg, png, webp, bmp, gif
  
- **提示词文件**: 编辑 `input/text/text.txt` 文件
  - 文件内容即为生成图像的提示词
  - 所有任务使用相同的提示词

### 4. 运行脚本

```powershell
python batch_banana_concurrent.py
```

### 5. 查看结果

生成的图像保存在 `batch_outputs/` 目录中，文件命名格式：
- `Task_1_imagename_1.png` (第1个任务，第1张图)
- `Task_2_imagename_1.png` (第2个任务，第1张图)
- ...

## 配置选项

在 `batch_banana_concurrent.py` 中可以调整以下参数：

```python
MAX_WORKERS = 5              # 并发数量（建议2-10）
MODEL = "nano-banana-fast"   # 模型选择
ASPECT_RATIO = "auto"        # 宽高比设置
```

### 可用的宽高比选项：
- `auto` - 自动
- `1:1` - 正方形
- `16:9` - 横向宽屏
- `9:16` - 竖向宽屏
- `4:3` - 横向标准
- `3:4` - 竖向标准
- `3:2` - 横向相机
- `2:3` - 竖向相机
- `5:4` - 横向
- `4:5` - 竖向
- `21:9` - 超宽屏

### 可用的模型：
- `nano-banana` - 标准模型
- `nano-banana-fast` - 快速模型（推荐）

## 性能说明

- **并发数量**: 默认5个并发任务，可根据API限制和网络情况调整
- **处理速度**: 使用fast模型时，单个任务约10-30秒
- **批量处理**: 10个任务使用5并发约需1-2分钟

## 输出示例

```
🚀 批量并发Banana图像生成任务
================================================================================
✅ API密钥已加载: sk-cea0fa...
📁 输出目录: C:\Users\1\Desktop\banana\batch_outputs
📝 提示词: 换一个自然休闲优雅的pose，保持面无表情,衣服和背景不变,参考大品牌服装的商业拍摄
🖼️ 找到 4 个图像文件:
   - 414eb0a3ff81fe1a714cd443822fb2d0.jpg
   - ComfyUI_temp_gypeu_00001_.png
   - ComfyUI_temp_opcii_00025_.png
   - G-ComfyUI_00530_.png

⚙️ 配置:
   - 模型: nano-banana-fast
   - 宽高比: auto
   - 并发数: 5
   - 任务总数: 4

================================================================================
按回车键开始批量处理...

============================================================
🚀 开始处理: Task_1_414eb0a3ff81fe1a714cd443822fb2d0
📝 提示词: 换一个自然休闲优雅的pose，保持面无表情,衣服和背景不变,参考大品牌服装...
🖼️ 输入图像: 414eb0a3ff81fe1a714cd443822fb2d0.jpg
============================================================
...
✅ Task_1_414eb0a3ff81fe1a714cd443822fb2d0 成功生成 1 张图像 | ⏱️ 15.32s
💾 已保存: Task_1_414eb0a3ff81fe1a714cd443822fb2d0_1.png

================================================================================
📊 批量处理完成!
================================================================================
⏱️ 总耗时: 45.67s
✅ 成功: 4/4
❌ 失败: 0/4

💾 输出目录: C:\Users\1\Desktop\banana\batch_outputs
================================================================================
```

## 注意事项

1. **API限制**: 请注意API的速率限制和配额
2. **并发数量**: 不要设置过高的并发数，可能会被限流
3. **网络稳定**: 确保网络连接稳定，每个任务需要下载生成的图像
4. **磁盘空间**: 确保有足够的磁盘空间存储生成的图像
5. **上传功能**: 如需使用输入图像，需要实现upload.py中的上传功能

## 错误处理

脚本会自动处理以下错误：
- API调用失败（自动重试）
- 网络超时
- 图像保存失败
- 单个任务失败不影响其他任务

失败的任务会在最后的总结中列出。

## 高级用法

### 只使用提示词生成（不使用输入图像）

如果input/image目录为空，脚本会只使用提示词生成图像。

### 修改提示词

可以在代码中修改为从不同文件读取提示词，或为每个图像使用不同的提示词。

### 自定义输出命名

修改 `process_single_task` 函数中的输出文件命名逻辑。

## 故障排查

### 问题：找不到API密钥
**解决**: 检查.env文件是否存在，GRSAI_API_KEY是否正确设置

### 问题：图像上传失败
**解决**: upload.py是占位符实现，需要根据实际API实现上传功能

### 问题：并发任务被限流
**解决**: 降低MAX_WORKERS的值

### 问题：生成的图像无法保存
**解决**: 检查输出目录权限，确保有写入权限
